<?php
/**
 * SCRIPT DE TEST DE S√âCURIT√â COMPLET
 * V√©rifie tous les aspects de s√©curit√© du site Elixir du Temps
 */

// Inclure les d√©pendances n√©cessaires
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../php/config/database.php';

class SecurityTester {
    
    private $results = [];
    private $totalTests = 0;
    private $passedTests = 0;
    
    public function __construct() {
        echo "üîí ELIXIR DU TEMPS - AUDIT DE S√âCURIT√â COMPLET\n";
        echo "================================================\n\n";
    }
    
    /**
     * Lance tous les tests de s√©curit√©
     */
    public function runAllTests() {
        $this->testConfigurationSecurity();
        $this->testFilePermissions();
        $this->testDatabaseSecurity();
        $this->testHTTPHeaders();
        $this->testInputValidation();
        $this->testSessionSecurity();
        $this->testFileUploadSecurity();
        $this->testAuthenticationSecurity();
        $this->testPasswordSecurity();
        $this->testCSRFProtection();
        $this->testSQLInjectionProtection();
        $this->testXSSProtection();
        $this->testDirectoryTraversal();
        $this->testRateLimiting();
        $this->testErrorHandling();
        $this->testLoggingSecurity();
        $this->testBackupSecurity();
        $this->testHTTPSSecurity();
        $this->testAccessControls();
        
        $this->displayResults();
    }
    
    /**
     * Test de la configuration de s√©curit√©
     */
    private function testConfigurationSecurity() {
        echo "1. Test de la configuration de s√©curit√©...\n";
        
        // Test des constantes de s√©curit√©
        $this->check(
            defined('ENCRYPTION_KEY') && !empty(ENCRYPTION_KEY),
            "Cl√© de chiffrement d√©finie"
        );
        
        $this->check(
            defined('CSRF_TOKEN_LIFETIME') && CSRF_TOKEN_LIFETIME > 0,
            "Dur√©e de vie des tokens CSRF configur√©e"
        );
        
        $this->check(
            defined('MAX_LOGIN_ATTEMPTS') && MAX_LOGIN_ATTEMPTS <= 5,
            "Limitation des tentatives de connexion"
        );
        
        // Test de la configuration PHP
        $this->check(
            ini_get('display_errors') == '0',
            "Affichage des erreurs d√©sactiv√©"
        );
        
        $this->check(
            ini_get('expose_php') == '0' || ini_get('expose_php') == '',
            "Masquage de la version PHP"
        );
        
        $this->check(
            ini_get('session.cookie_httponly') == '1',
            "Cookies de session HTTP-only"
        );
        
        echo "\n";
    }
    
    /**
     * Test des permissions de fichiers
     */
    private function testFilePermissions() {
        echo "2. Test des permissions de fichiers...\n";
        
        $sensitiveFiles = [
            __DIR__ . '/../config/config.php' => 'Configuration principale',
            __DIR__ . '/../.htaccess' => 'Fichier .htaccess principal',
            __DIR__ . '/../php/.htaccess' => 'Protection du dossier PHP',
            __DIR__ . '/../config/.htaccess' => 'Protection du dossier config'
        ];
        
        foreach ($sensitiveFiles as $file => $description) {
            if (file_exists($file)) {
                $perms = fileperms($file);
                $this->check(
                    ($perms & 0044) === 0,
                    "$description - Lecture monde interdite"
                );
            } else {
                $this->check(false, "$description - Fichier manquant");
            }
        }
        
        // Test des r√©pertoires sensibles
        $sensitiveDirs = [
            __DIR__ . '/../logs' => 'R√©pertoire des logs',
            __DIR__ . '/../config' => 'R√©pertoire de configuration'
        ];
        
        foreach ($sensitiveDirs as $dir => $description) {
            if (is_dir($dir)) {
                $perms = fileperms($dir);
                $this->check(
                    ($perms & 0005) === 0,
                    "$description - Acc√®s monde interdit"
                );
            }
        }
        
        echo "\n";
    }
    
    /**
     * Test de la s√©curit√© de la base de donn√©es
     */
    private function testDatabaseSecurity() {
        echo "3. Test de la s√©curit√© de la base de donn√©es...\n";
        
        try {
            $db = new Database();
            $pdo = $db->getConnection();
            
            // Test de la connexion s√©curis√©e
            $this->check(
                $pdo instanceof PDO,
                "Connexion √† la base de donn√©es √©tablie"
            );
            
            // Test des requ√™tes pr√©par√©es (simulation)
            $stmt = $pdo->prepare("SHOW TABLES");
            $stmt->execute();
            $this->check(
                $stmt !== false,
                "Support des requ√™tes pr√©par√©es"
            );
            
            // Test des privil√®ges utilisateur (basique)
            $stmt = $pdo->query("SELECT USER()");
            $user = $stmt->fetchColumn();
            $this->check(
                !str_contains(strtolower($user), 'root@'),
                "Utilisateur non-root pour la base de donn√©es"
            );
            
        } catch (Exception $e) {
            $this->check(false, "Erreur de connexion base de donn√©es: " . $e->getMessage());
        }
        
        echo "\n";
    }
    
    /**
     * Test des headers HTTP de s√©curit√©
     */
    private function testHTTPHeaders() {
        echo "4. Test des headers HTTP de s√©curit√©...\n";
        
        // Simuler une requ√™te pour tester les headers
        ob_start();
        include __DIR__ . '/../config/config.php';
        $headers = headers_list();
        ob_end_clean();
        
        $expectedHeaders = [
            'X-Frame-Options' => 'Protection clickjacking',
            'X-XSS-Protection' => 'Protection XSS',
            'X-Content-Type-Options' => 'Protection MIME sniffing',
            'Content-Security-Policy' => 'Content Security Policy',
            'Referrer-Policy' => 'Politique de r√©f√©rent'
        ];
        
        foreach ($expectedHeaders as $header => $description) {
            $found = false;
            foreach ($headers as $sentHeader) {
                if (str_starts_with($sentHeader, $header . ':')) {
                    $found = true;
                    break;
                }
            }
            $this->check($found, $description);
        }
        
        echo "\n";
    }
    
    /**
     * Test de validation des entr√©es
     */
    private function testInputValidation() {
        echo "5. Test de la validation des entr√©es...\n";
        
        // Test des fonctions de s√©curit√©
        $this->check(
            function_exists('secureInput'),
            "Fonction de nettoyage d'entr√©e disponible"
        );
        
        $this->check(
            function_exists('detectAttackPatterns'),
            "Fonction de d√©tection d'attaques disponible"
        );
        
        // Test de validation d'email
        $testEmail = "test@example.com";
        $this->check(
            filter_var($testEmail, FILTER_VALIDATE_EMAIL) !== false,
            "Validation d'email fonctionnelle"
        );
        
        // Test de nettoyage XSS
        $xssTest = "<script>alert('xss')</script>";
        $cleaned = htmlspecialchars($xssTest, ENT_QUOTES, 'UTF-8');
        $this->check(
            $cleaned !== $xssTest,
            "Protection XSS dans le nettoyage"
        );
        
        echo "\n";
    }
    
    /**
     * Test de la s√©curit√© des sessions
     */
    private function testSessionSecurity() {
        echo "6. Test de la s√©curit√© des sessions...\n";
        
        $this->check(
            ini_get('session.cookie_httponly') == '1',
            "Sessions HTTP-only activ√©es"
        );
        
        $this->check(
            ini_get('session.cookie_secure') == '1',
            "Sessions s√©curis√©es (HTTPS)"
        );
        
        $this->check(
            ini_get('session.use_strict_mode') == '1',
            "Mode strict des sessions activ√©"
        );
        
        $this->check(
            session_status() === PHP_SESSION_ACTIVE,
            "Session d√©marr√©e correctement"
        );
        
        echo "\n";
    }
    
    /**
     * Test de s√©curit√© des uploads
     */
    private function testFileUploadSecurity() {
        echo "7. Test de la s√©curit√© des uploads...\n";
        
        $uploadDir = __DIR__ . '/../public/uploads';
        $this->check(
            is_dir($uploadDir),
            "R√©pertoire d'upload existe"
        );
        
        $htaccessUpload = $uploadDir . '/.htaccess';
        $this->check(
            file_exists($htaccessUpload),
            "Protection .htaccess dans uploads"
        );
        
        if (file_exists($htaccessUpload)) {
            $content = file_get_contents($htaccessUpload);
            $this->check(
                str_contains($content, 'php_flag engine off'),
                "Ex√©cution PHP d√©sactiv√©e dans uploads"
            );
        }
        
        echo "\n";
    }
    
    /**
     * Test de s√©curit√© d'authentification
     */
    private function testAuthenticationSecurity() {
        echo "8. Test de la s√©curit√© d'authentification...\n";
        
        $this->check(
            function_exists('password_hash'),
            "Fonction de hashage de mot de passe disponible"
        );
        
        $this->check(
            function_exists('password_verify'),
            "Fonction de v√©rification de mot de passe disponible"
        );
        
        // Test du hashage
        $testPassword = "TestPassword123!";
        $hash = password_hash($testPassword, PASSWORD_DEFAULT);
        $this->check(
            password_verify($testPassword, $hash),
            "Hashage/v√©rification de mot de passe fonctionnel"
        );
        
        echo "\n";
    }
    
    /**
     * Test de la politique de mot de passe
     */
    private function testPasswordSecurity() {
        echo "9. Test de la politique de mot de passe...\n";
        
        $this->check(
            defined('PASSWORD_MIN_LENGTH') && PASSWORD_MIN_LENGTH >= 8,
            "Longueur minimum de mot de passe (8+ caract√®res)"
        );
        
        $this->check(
            defined('PASSWORD_REQUIRE_SPECIAL') && PASSWORD_REQUIRE_SPECIAL,
            "Caract√®res sp√©ciaux requis"
        );
        
        $this->check(
            defined('PASSWORD_REQUIRE_NUMBERS') && PASSWORD_REQUIRE_NUMBERS,
            "Chiffres requis"
        );
        
        $this->check(
            defined('PASSWORD_REQUIRE_UPPERCASE') && PASSWORD_REQUIRE_UPPERCASE,
            "Majuscules requises"
        );
        
        echo "\n";
    }
    
    /**
     * Test de protection CSRF
     */
    private function testCSRFProtection() {
        echo "10. Test de la protection CSRF...\n";
        
        $this->check(
            function_exists('generateSecureCSRFToken'),
            "Fonction de g√©n√©ration de token CSRF disponible"
        );
        
        $this->check(
            function_exists('validateSecureCSRFToken'),
            "Fonction de validation de token CSRF disponible"
        );
        
        // Test de g√©n√©ration de token
        if (function_exists('generateSecureCSRFToken')) {
            $token = generateSecureCSRFToken();
            $this->check(
                !empty($token) && strlen($token) >= 32,
                "Token CSRF g√©n√©r√© avec longueur suffisante"
            );
        }
        
        echo "\n";
    }
    
    /**
     * Test de protection SQL Injection
     */
    private function testSQLInjectionProtection() {
        echo "11. Test de protection contre l'injection SQL...\n";
        
        $sqlInjectionTests = [
            "'; DROP TABLE users; --",
            "1' OR '1'='1",
            "UNION SELECT password FROM users",
            "admin'--",
            "' OR 1=1#"
        ];
        
        foreach ($sqlInjectionTests as $test) {
            if (function_exists('detectAttackPatterns')) {
                $detected = detectAttackPatterns($test);
                $this->check($detected, "D√©tection injection SQL: " . substr($test, 0, 20) . "...");
            }
        }
        
        echo "\n";
    }
    
    /**
     * Test de protection XSS
     */
    private function testXSSProtection() {
        echo "12. Test de protection contre XSS...\n";
        
        $xssTests = [
            "<script>alert('xss')</script>",
            "javascript:alert('xss')",
            "<img src=x onerror=alert('xss')>",
            "<iframe src='javascript:alert()'></iframe>",
            "eval('alert(1)')"
        ];
        
        foreach ($xssTests as $test) {
            $cleaned = htmlspecialchars($test, ENT_QUOTES, 'UTF-8');
            $this->check($cleaned !== $test, "Protection XSS: " . substr($test, 0, 20) . "...");
        }
        
        echo "\n";
    }
    
    /**
     * Test de protection Directory Traversal
     */
    private function testDirectoryTraversal() {
        echo "13. Test de protection contre Directory Traversal...\n";
        
        $traversalTests = [
            "../../../etc/passwd",
            "..\\..\\windows\\system32\\config\\sam",
            "....//....//etc/passwd",
            "%2e%2e%2f%2e%2e%2f%etc%2fpasswd"
        ];
        
        foreach ($traversalTests as $test) {
            if (function_exists('detectAttackPatterns')) {
                $detected = detectAttackPatterns($test);
                $this->check($detected, "D√©tection traversal: " . substr($test, 0, 20) . "...");
            }
        }
        
        echo "\n";
    }
    
    /**
     * Test de limitation de taux
     */
    private function testRateLimiting() {
        echo "14. Test de limitation de taux...\n";
        
        $this->check(
            class_exists('BruteForceProtection') || file_exists('../php/utils/BruteForceProtection.php'),
            "Syst√®me de protection contre la force brute disponible"
        );
        
        $this->check(
            defined('MAX_LOGIN_ATTEMPTS'),
            "Limite de tentatives de connexion d√©finie"
        );
        
        $this->check(
            defined('LOGIN_LOCKOUT_TIME'),
            "Temps de blocage d√©fini"
        );
        
        echo "\n";
    }
    
    /**
     * Test de gestion des erreurs
     */
    private function testErrorHandling() {
        echo "15. Test de la gestion des erreurs...\n";
        
        $this->check(
            ini_get('display_errors') == '0',
            "Affichage des erreurs d√©sactiv√©"
        );
        
        $this->check(
            ini_get('log_errors') == '1',
            "Logging des erreurs activ√©"
        );
        
        $errorLogFile = ini_get('error_log');
        $this->check(
            !empty($errorLogFile),
            "Fichier de log d'erreur configur√©"
        );
        
        echo "\n";
    }
    
    /**
     * Test de s√©curit√© des logs
     */
    private function testLoggingSecurity() {
        echo "16. Test de la s√©curit√© des logs...\n";
        
        $this->check(
            function_exists('secureLog'),
            "Fonction de logging s√©curis√© disponible"
        );
        
        $logsDir = __DIR__ . '/../logs';
        if (is_dir($logsDir)) {
            $this->check(
                is_writable($logsDir),
                "R√©pertoire de logs accessible en √©criture"
            );
            
            $perms = fileperms($logsDir);
            $this->check(
                ($perms & 0044) === 0,
                "R√©pertoire de logs non lisible par le monde"
            );
        }
        
        echo "\n";
    }
    
    /**
     * Test de s√©curit√© des sauvegardes
     */
    private function testBackupSecurity() {
        echo "17. Test de la s√©curit√© des sauvegardes...\n";
        
        $backupPatterns = ['*.sql', '*.bak', '*.backup', '*.dump'];
        $foundBackups = [];
        
        foreach ($backupPatterns as $pattern) {
            $files = glob(__DIR__ . "/../$pattern");
            $foundBackups = array_merge($foundBackups, $files);
        }
        
        $this->check(
            empty($foundBackups),
            "Aucun fichier de sauvegarde expos√© trouv√©"
        );
        
        if (!empty($foundBackups)) {
            echo "   ‚ö†Ô∏è  Fichiers de sauvegarde trouv√©s: " . implode(', ', $foundBackups) . "\n";
        }
        
        echo "\n";
    }
    
    /**
     * Test de s√©curit√© HTTPS
     */
    private function testHTTPSSecurity() {
        echo "18. Test de la s√©curit√© HTTPS...\n";
        
        $this->check(
            isset($_SERVER['HTTPS']) || $_SERVER['SERVER_PORT'] == 443,
            "Connexion HTTPS d√©tect√©e"
        );
        
        // Test HSTS en production
        if (defined('APP_ENV') && APP_ENV === 'production') {
            $this->check(
                in_array('Strict-Transport-Security', headers_list()),
                "Header HSTS pr√©sent en production"
            );
        }
        
        echo "\n";
    }
    
    /**
     * Test des contr√¥les d'acc√®s
     */
    private function testAccessControls() {
        echo "19. Test des contr√¥les d'acc√®s...\n";
        
        $this->check(
            function_exists('isLoggedIn'),
            "Fonction de v√©rification de connexion disponible"
        );
        
        $this->check(
            function_exists('isAdmin'),
            "Fonction de v√©rification admin disponible"
        );
        
        $this->check(
            function_exists('checkAccess'),
            "Fonction de contr√¥le d'acc√®s disponible"
        );
        
        echo "\n";
    }
    
    /**
     * V√©rifie une condition et enregistre le r√©sultat
     */
    private function check($condition, $description) {
        $this->totalTests++;
        
        if ($condition) {
            echo "   ‚úÖ $description\n";
            $this->passedTests++;
            $this->results[] = ['status' => 'PASS', 'test' => $description];
        } else {
            echo "   ‚ùå $description\n";
            $this->results[] = ['status' => 'FAIL', 'test' => $description];
        }
    }
    
    /**
     * Affiche les r√©sultats finaux
     */
    private function displayResults() {
        echo "\n" . str_repeat("=", 50) . "\n";
        echo "R√âSULTATS DE L'AUDIT DE S√âCURIT√â\n";
        echo str_repeat("=", 50) . "\n";
        
        $failedTests = $this->totalTests - $this->passedTests;
        $successRate = round(($this->passedTests / $this->totalTests) * 100, 1);
        
        echo "Total des tests: $this->totalTests\n";
        echo "Tests r√©ussis: $this->passedTests\n";
        echo "Tests √©chou√©s: $failedTests\n";
        echo "Taux de r√©ussite: $successRate%\n\n";
        
        // D√©terminer le niveau de s√©curit√©
        if ($successRate >= 95) {
            echo "üõ°Ô∏è  NIVEAU DE S√âCURIT√â: EXCELLENT\n";
            echo "   Votre site est tr√®s bien s√©curis√©.\n";
        } elseif ($successRate >= 85) {
            echo "üîí NIVEAU DE S√âCURIT√â: TR√àS BON\n";
            echo "   Quelques am√©liorations mineures recommand√©es.\n";
        } elseif ($successRate >= 75) {
            echo "‚ö†Ô∏è  NIVEAU DE S√âCURIT√â: CORRECT\n";
            echo "   Des am√©liorations sont n√©cessaires.\n";
        } elseif ($successRate >= 60) {
            echo "üö® NIVEAU DE S√âCURIT√â: INSUFFISANT\n";
            echo "   Des mesures correctives urgentes sont requises.\n";
        } else {
            echo "üíÄ NIVEAU DE S√âCURIT√â: CRITIQUE\n";
            echo "   S√©curisation imm√©diate n√©cessaire!\n";
        }
        
        // Afficher les tests √©chou√©s
        if ($failedTests > 0) {
            echo "\nüìã TESTS √âCHOU√âS:\n";
            foreach ($this->results as $result) {
                if ($result['status'] === 'FAIL') {
                    echo "   ‚Ä¢ {$result['test']}\n";
                }
            }
        }
        
        echo "\nüï∞Ô∏è Audit termin√© - " . date('Y-m-d H:i:s') . "\n";
    }
}

// Ex√©cuter l'audit si le script est appel√© directement
if (basename(__FILE__) == basename($_SERVER['SCRIPT_NAME'])) {
    $tester = new SecurityTester();
    $tester->runAllTests();
}
